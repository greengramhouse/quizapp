<script>
/* -------------------------
  Global app state
--------------------------*/
let setsData = []; // loaded from JSON
let userLineId = null; // changed from email to LINE user ID
let theme = null;
let currentSetIndex = 0;
let currentQuiz = [];
let userAnswers = {}; // mapping questionIndex -> selectedChoice
let currentIndex = 0;
let timer = null;
let timePerQuestion = 60;
const LIFF_ID = '2006372130-PYKdNb1r'; // LINE LIFF ID

/* ---------- helpers for storage keys ---------- */
function storageKeyAnswers(setIndex, lineId) {
  return `quiz_answers_${lineId}_set${setIndex}`;
}
function storageKeyMeta(lineId) {
  return `quiz_meta_${lineId}`; // store unlocked, theme etc.
}

/* ---------- LIFF initialization ---------- */
async function initializeLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      const profile = await liff.getProfile();
      userLineId = profile.userId;
      localStorage.setItem('quizUserLineId', userLineId);
      // update UI
      document.getElementById('loggedUser').innerText = `${profile.displayName || 'ผู้ใช้'} (LINE)`;
      document.getElementById('btnLogout').classList.remove('hidden');
      
      // auto load quiz or show set selection
      loadAfterLogin();
    }
  } catch (e) {
    console.error('LIFF init error:', e);
    Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อ LINE ได้: ' + e.message, 'error');
  }
}

async function handleLineLogin() {
  if (!liff.isLoggedIn()) {
    liff.login();
  } else {
    try {
      const profile = await liff.getProfile();
      userLineId = profile.userId;
      localStorage.setItem('quizUserLineId', userLineId);
      document.getElementById('loggedUser').innerText = `${profile.displayName || 'ผู้ใช้'} (LINE)`;
      document.getElementById('btnLogout').classList.remove('hidden');
      
      loadAfterLogin();
    } catch (e) {
      console.error('Failed to get profile:', e);
      Swal.fire('ข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลบัญชี LINE ได้', 'error');
    }
  }
}

function loadAfterLogin() {
  const meta = loadMeta();
  const unlocked = meta ? (meta.unlocked || 0) : 0;
  
  // if there is incomplete work on any unlocked set, load that automatically
  for (let i=0;i<=unlocked;i++){
    const answers = loadAnswers(i);
    const answeredCount = Object.keys(answers).length;
    const total = setsData[i].questions.length;
    if (answeredCount>0 && answeredCount<total) {
      // resume this set
      currentSetIndex = i;
      currentQuiz = setsData[i].questions;
      userAnswers = answers;
      currentIndex = answeredCount; // continue next unanswered
      openQuizUI();
      loadQuestion();
      return;
    }
  }

  // else go to set selection
  document.getElementById('homeInfo').innerText = `เลือกชุดข้อสอบหรือตั้งค่าเวลา`;
  goSetPage();
}

/* ---------- fetch questions JSON ---------- */
async function loadQuestions() {
  try {
    const res = await fetch('questions.json');
    if (!res.ok) throw new Error('ไม่สามารถโหลด questions.json ได้');
    const data = await res.json();
    setsData = data.sets;
    renderSetSelect();
    renderSetsStatus();
  } catch (e) {
    Swal.fire('โหลดคำถามล้มเหลว', e.message + '\n(ต้องวาง questions.json ในโฟลเดอร์เดียวกัน และเปิดผ่านเว็บเซิร์ฟเวอร์)', 'error');
    console.error(e);
  }
}

/* ---------- UI render helpers ---------- */
function renderSetSelect() {
  const sel = document.getElementById('setSelect');
  sel.innerHTML = '';
  setsData.forEach((s, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `ชุดที่ ${i+1} - ${s.title || ''}`;
    sel.appendChild(opt);
  });
  updateUnlockedOptions();
}

function updateUnlockedOptions() {
  const sel = document.getElementById('setSelect');
  const meta = loadMeta();
  const unlocked = meta ? (meta.unlocked || 0) : 0;
  Array.from(sel.options).forEach((opt, idx) => {
    opt.disabled = idx > unlocked;
    opt.innerText = `ชุดที่ ${idx+1} - ${setsData[idx].title || ''}` + (idx > unlocked ? ' (ล็อก)' : '');
  });
  // rebuild results menu
  buildResultsMenu();
}

function updateUnlockedFromMeta() {
  updateUnlockedOptions();
}

function renderSetsStatus() {
  const div = document.getElementById('setsStatus');
  div.innerHTML = '';
  setsData.forEach((s, i) => {
    const saved = loadAnswers(i);
    const answered = Object.keys(saved).length;
    const total = s.questions.length;
    const el = document.createElement('div');
    el.className = 'flex items-center justify-between';
    el.innerHTML = `<div><strong>ชุด ${i+1}</strong> ${s.title ? '- ' + s.title : ''}</div>
      <div class="text-sm text-gray-600">${answered}/${total} ข้อ</div>`;
    div.appendChild(el);
  });
}

/* ---------- load/save meta ---------- */
function loadMeta() {
  const lineId = localStorage.getItem('quizUserLineId');
  if (!lineId) return null;
  const raw = localStorage.getItem(storageKeyMeta(lineId));
  return raw ? JSON.parse(raw) : { unlocked:0, theme:'pink' };
}
function saveMeta(meta){
  const lineId = localStorage.getItem('quizUserLineId');
  if (!lineId) return;
  localStorage.setItem(storageKeyMeta(lineId), JSON.stringify(meta));
}

/* ---------- load/save answers ---------- */
function loadAnswers(setIndex) {
  const lineId = localStorage.getItem('quizUserLineId');
  if (!lineId) return {};
  const raw = localStorage.getItem(storageKeyAnswers(setIndex, lineId));
  return raw ? JSON.parse(raw) : {};
}
function saveAnswers(setIndex, answers) {
  const lineId = localStorage.getItem('quizUserLineId');
  if (!lineId) return;
  localStorage.setItem(storageKeyAnswers(setIndex, lineId), JSON.stringify(answers));
  renderSetsStatus();
}

/* ---------- handle start / login ---------- */
function handleStart(){
  const th = document.getElementById('themeSelect').value;
  if (!userLineId) {
    Swal.fire('แจ้งเตือน', 'กรุณาเข้าสู่ระบบ LINE ก่อน', 'warning');
    return;
  }
  
  // load meta if any
  let meta = loadMeta();
  if (!meta) {
    meta = { unlocked:0, theme: th };
    saveMeta(meta);
  } else {
    // keep stored theme unless user changed
    meta.theme = th;
    saveMeta(meta);
  }
  applyTheme(meta.theme);

  // if there is incomplete work on any unlocked set, load that automatically
  const unlocked = meta.unlocked || 0;
  for (let i=0;i<=unlocked;i++){
    const answers = loadAnswers(i);
    const answeredCount = Object.keys(answers).length;
    const total = setsData[i].questions.length;
    if (answeredCount>0 && answeredCount<total) {
      // resume this set
      currentSetIndex = i;
      currentQuiz = setsData[i].questions;
      userAnswers = answers;
      currentIndex = answeredCount; // continue next unanswered
      openQuizUI();
      loadQuestion();
      return;
    }
  }

  // else go to set selection
  document.getElementById('homeInfo').innerText = `เลือกชุดข้อสอบหรือตั้งค่าเวลา`;
  goSetPage();
}

/* ---------- theme ---------- */
function applyTheme(th){
  document.body.classList.remove('theme-pink','theme-green','theme-blue');
  if (th === 'pink') document.body.classList.add('theme-pink');
  if (th === 'green') document.body.classList.add('theme-green');
  if (th === 'blue') document.body.classList.add('theme-blue');
}

/* ---------- navigation helpers ---------- */
function goHome(){ showSection('homeSection'); }
function goSetPage(){ 
  updateUnlockedOptions();
  document.getElementById('setSelect').value = 0; // reset to first set
  goQuiz(); 
} // alias for quiz page with set selection
function goQuiz(){ showSection('quizSection'); }
function goBackToSetSelect(){
  // Go back to quiz section and set dropdown to current set
  updateUnlockedOptions();
  document.getElementById('setSelect').value = currentSetIndex;
  document.getElementById('displaySetTitle').innerText = `ชุดที่ ${currentSetIndex+1} - ${setsData[currentSetIndex].title}`;
  goQuiz();
}
function goResults(){ showSection('resultSection'); }

/* mobile */
function toggleMobile(){ document.getElementById('mobileNav').classList.toggle('hidden'); }

/* ---------- start quiz ---------- */
function handleSetChange(){
  const sel = document.getElementById('setSelect');
  const idx = Number(sel.value);
  // just update the display, don't start yet
  if (setsData[idx]) {
    document.getElementById('displaySetTitle').innerText = `ชุดที่ ${idx+1} - ${setsData[idx].title}`;
  }
  startQuiz();
}

function startQuiz(){
  const sel = document.getElementById('setSelect');
  const idx = Number(sel.value);
  currentSetIndex = idx;
  currentQuiz = setsData[idx].questions;
  userAnswers = loadAnswers(idx) || {};
  currentIndex = 0;
  timePerQuestion = Number(document.getElementById('timePerQuestion').value) || 60;
  openQuizUI();
  loadQuestion();
}

/* open quiz UI (fill titles) */
function openQuizUI(){
  document.getElementById('displayEmail').innerText = userLineId || '';
  document.getElementById('displaySetTitle').innerText = `ชุดที่ ${currentSetIndex+1} - ${setsData[currentSetIndex].title}`;
  showSection('quizSection');
  document.getElementById('navQuiz').classList.add('active');
  updateUnlockedOptions();
  buildResultsMenu();
}

/* ---------- question rendering + timer ---------- */
function loadQuestion(){
  // clear previous timer
  stopTimer();

  if (!currentQuiz || currentQuiz.length===0) return;

  const q = currentQuiz[currentIndex];
  document.getElementById('questionText').innerText = `ข้อ ${currentIndex+1}: ${q.q}`;
  const choicesBox = document.getElementById('choicesBox');
  choicesBox.innerHTML = '';
  q.choices.forEach((c, idx) => {
    const checked = (userAnswers[currentIndex] === c) ? 'checked' : '';
    const lbl = document.createElement('label');
    lbl.className = 'flex items-center gap-3 p-2 border rounded hover:bg-gray-50';
    lbl.innerHTML = `<input type="radio" name="choice" value="${c}" ${checked}> <span>${c}</span>`;
    choicesBox.appendChild(lbl);
  });

  // update counters
  document.getElementById('qIndicator').innerText = `ข้อที่ ${currentIndex+1} / ${currentQuiz.length}`;
  // start timer
  timePerQuestion = Number(document.getElementById('timePerQuestion').value) || 60;
  startTimer(timePerQuestion);
  updateProgressFill();
}

/* save selected answer */
function saveCurrentAnswer(){
  const sel = document.querySelector("input[name='choice']:checked");
  if (sel){
    userAnswers[currentIndex] = Number(sel.value);
    saveAnswers(currentSetIndex, userAnswers);
  }
}

/* next / prev */
function nextQuestion(){
  // try save
  saveCurrentAnswer();
  // enforce answer?
  if (userAnswers[currentIndex] === undefined){
    Swal.fire({
      title: 'ยังไม่ได้ตอบ',
      text: 'คุณยังไม่ได้ตอบข้อปัจจุบัน ต้องการข้ามหรือไม่?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'ข้ามไป',
      cancelButtonText: 'ยกเลิก'
    }).then((result) => {
      if (result.isConfirmed) {
        if (currentIndex < currentQuiz.length-1){
          currentIndex++;
          loadQuestion();
        } else {
          showResultFor(currentSetIndex);
        }
      }
    });
    return;
  }
  if (currentIndex < currentQuiz.length-1){
    currentIndex++;
    loadQuestion();
  } else {
    // finish
    saveCurrentAnswer();
    showResultFor(currentSetIndex);
  }
}

function prevQuestion(){
  saveCurrentAnswer();
  if (currentIndex>0){
    currentIndex--;
    loadQuestion();
  }
}

/* save & quit (user chooses to stop and return later) */
function saveAndQuit(){
  saveCurrentAnswer();
  Swal.fire('สำเร็จ', 'บันทึกเรียบร้อย คุณสามารถกลับมาทำต่อได้โดยใช้บัญชี LINE เดิม', 'success');
  goHome();
}

/* ---------- timer ---------- */
let remaining = 0;
function startTimer(seconds){
  remaining = seconds;
  document.getElementById('timeLeft').innerText = remaining;
  timer = setInterval(()=>{
    remaining--;
    document.getElementById('timeLeft').innerText = remaining;
    if (remaining<=0){
      clearInterval(timer);
      // on timeout: treat as unanswered (or leave undefined) and go next
      // here we leave unanswered and move on
      if (currentIndex < currentQuiz.length-1) {
        currentIndex++;
        loadQuestion();
      } else {
        showResultFor(currentSetIndex);
      }
    }
  },1000);
}
function stopTimer(){ if (timer) { clearInterval(timer); timer = null; } }

/* ---------- progress bar ---------- */
function updateProgressFill(){
  const ratio = ((currentIndex+1)/currentQuiz.length)*100;
  document.getElementById('progressFill').style.width = ratio + '%';
}

/* ---------- show results UI ---------- */
function showResultFor(setIndex){
  stopTimer();
  const set = setsData[setIndex];
  const answers = loadAnswers(setIndex);
  // ensure store current answers too
  saveAnswers(setIndex, userAnswers);

  // compute stats
  const total = set.questions.length;
  let correct = 0;
  let answered = Object.keys(answers).length;
  // compute correct using saved userAnswers (merged)
  const merged = {...answers, ...userAnswers};
  for (let i=0;i<total;i++){
    if (merged[i] !== undefined && merged[i] === set.questions[i].answer) correct++;
  }

  // write summary UI
  document.getElementById('resEmail').innerText = userLineId || '';
  document.getElementById('resSetTitle').innerText = `ชุดที่ ${setIndex+1} - ${set.title}`;
  document.getElementById('resScore').innerText = `ถูก ${correct} / ${total} (ตอบแล้ว ${answered}/${total})`;

  // list answers & show correct/incorrect
  const list = document.getElementById('answerList');
  list.innerHTML = '';
  for (let i=0;i<total;i++){
    const q = set.questions[i];
    const ans = merged[i];
    const ok = (ans !== undefined && ans === q.answer);
    const el = document.createElement('div');
    el.className = 'p-2 border-b';
    el.innerHTML = `<div class="font-medium">ข้อ ${i+1}: ${q.q}</div>
      <div>คำตอบของคุณ: <span class="${ok ? 'text-green-600' : 'text-red-600'}">${ans ?? '- (ไม่ได้ตอบ)'}</span></div>
      <div class="text-blue-700">เฉลย: ${q.answer}</div>`;
    list.appendChild(el);
  }

  // chart
  renderChart(correct, total);

  // unlock logic: if correct >= threshold
  const threshold = Math.ceil(total * 0.5); // >=50% (you can change)
  if (correct >= threshold && setIndex < setsData.length-1){
    // set next unlocked in meta
    const meta = loadMeta();
    if (meta){
      const nowUnlocked = Math.max(meta.unlocked || 0, setIndex+1);
      meta.unlocked = nowUnlocked;
      saveMeta(meta);
      updateUnlockedOptions();
      // auto-select next set for convenience
      const sel = document.getElementById('setSelect');
      if (sel){
        sel.value = Math.min(nowUnlocked, setsData.length-1);
      }
      // notify
      Swal.fire('ยินดีด้วย!', `ผ่านเกณฑ์ (${correct}/${total}) — ปลดล็อกชุดถัดไปแล้ว`, 'success');
    }
  }

  showSection('resultSection');
  // rebuild results menu
  updateUnlockedOptions(); // update dropdown status
  buildResultsMenu();
}

/* ---------- chart ---------- */
let scoreChart = null;
function renderChart(correct,total){
  const ctx = document.getElementById('scoreChart').getContext('2d');
  if (scoreChart) scoreChart.destroy();
  scoreChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['ถูก','ผิด'],
      datasets: [{
        data: [correct, total - correct],
        backgroundColor:['#16a34a','#ef4444']
      }]
    },
    options: { responsive:true, maintainAspectRatio: false }
  });
}

/* ---------- results menu (nav) ---------- */
function toggleResultsMenu(){
  const menu = document.getElementById('resultsMenu');
  menu.classList.toggle('hidden');
}

function buildResultsMenu(){
  const menu = document.getElementById('resultsMenu');
  menu.innerHTML = '';
  const lineId = localStorage.getItem('quizUserLineId');
  const meta = loadMeta();
  const unlocked = meta ? (meta.unlocked || 0) : 0;
  
  if (!setsData || setsData.length === 0) {
    const noData = document.createElement('div');
    noData.className = 'p-2 text-gray-500 text-sm';
    noData.innerText = 'ยังไม่มีข้อมูลชุดข้อสอบ';
    menu.appendChild(noData);
    return;
  }
  
  setsData.forEach((s, i) => {
    const saved = loadAnswers(i);
    const hasData = saved && Object.keys(saved).length > 0;
    const isLocked = i > unlocked;
    
    const item = document.createElement('button');
    item.className = 'w-full text-left p-2 border-b hover:bg-blue-50 transition';
    item.style.opacity = isLocked ? '0.5' : '1';
    item.style.cursor = isLocked ? 'not-allowed' : 'pointer';
    item.disabled = isLocked || !hasData;
    
    let status = '';
    if (isLocked) status = ' (ล็อก)';
    else if (!hasData) status = ' (ยังไม่มีข้อมูล)';
    
    item.innerText = `ชุด ${i+1}: ${s.title || ''}${status}`;
    
    item.onclick = ()=> {
      if (isLocked) {
        Swal.fire('แจ้งเตือน', 'ชุดข้อสอบนี้ถูกล็อกอยู่ คุณต้องผ่านเกณฑ์ของชุดก่อนหน้า', 'warning');
        return;
      }
      if (!hasData) {
        Swal.fire('แจ้งเตือน', 'ยังไม่มีผลลัพธ์ชุดนี้ กรุณาทำข้อสอบก่อน', 'info');
        return;
      }
      // load merged answers
      userAnswers = saved;
      document.getElementById('resultsMenu').classList.add('hidden');
      showResultFor(i);
    };
    menu.appendChild(item);
  });
}

/* mobile results */
function showResultsMenuMobile(){
  // show modal for mobile
  const meta = loadMeta();
  const unlocked = meta ? meta.unlocked||0:0;
  
  let options = {};
  setsData.forEach((s,i)=>{
    const saved = loadAnswers(i);
    const hasData = saved && Object.keys(saved).length > 0;
    const isLocked = i > unlocked;
    
    if (!isLocked && hasData) {
      options[`ชุด ${i+1}: ${s.title}`] = i;
    }
  });
  
  if (Object.keys(options).length === 0) {
    Swal.fire('แจ้งเตือน', 'ยังไม่มีผลลัพธ์ที่สามารถดูได้', 'info');
    return;
  }
  
  Swal.fire({
    title: 'เลือกชุดข้อสอบ',
    input: 'select',
    inputOptions: options,
    showCancelButton: true,
    confirmButtonText: 'แสดงผล',
    cancelButtonText: 'ยกเลิก'
  }).then((result) => {
    if (result.isConfirmed) {
      const setIndex = parseInt(result.value);
      userAnswers = loadAnswers(setIndex);
      showResultFor(setIndex);
    }
  });
}

/* ---------- utility: logout / clear ---------- */
function logout(){
  stopTimer();
  userLineId = null;
  localStorage.removeItem('quizUserLineId');
  document.getElementById('loggedUser').innerText = '';
  document.getElementById('btnLogout').classList.add('hidden');
  if (liff.isLoggedIn()) {
    liff.logout();
  }
  goHome();
}

function clearAll(){
  Swal.fire({
    title: 'ยืนยันการลบ',
    text: 'ต้องการลบข้อมูลทั้งหมดหรือไม่? การกระทำนี้ไม่สามารถคืนค่าได้',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'ใช่ ลบข้อมูล',
    cancelButtonText: 'ยกเลิก'
  }).then((result) => {
    if (result.isConfirmed) {
      localStorage.clear();
      Swal.fire('สำเร็จ', 'ข้อมูลถูกลบแล้ว', 'success').then(() => {
        location.reload();
      });
    }
  });
}

/* ---------- page utils ---------- */
function showSection(id){
  document.getElementById('homeSection').classList.add('hidden');
  document.getElementById('quizSection').classList.add('hidden');
  document.getElementById('resultSection').classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
  // update status displays
  document.getElementById('homeInfo').innerText = userLineId ? `เข้าสู่ระบบแล้ว` : '';
  document.getElementById('loggedUser').innerText = userLineId ? `ผู้ใช้ LINE: ${userLineId.substring(0, 10)}...` : '';
}

/* ---------- initial setup ---------- */
window.addEventListener('load', async ()=>{
  await loadQuestions();
  // Initialize LIFF
  await initializeLIFF();
  buildResultsMenu();
});

</script>
