<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MyQuiz — ระบบข้อสอบออนไลน์</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

  <style>
    /* small custom */
    .theme-pink { background: linear-gradient(180deg,#fff0f6,#ffe6ef); }
    .theme-green { background: linear-gradient(180deg,#f0fff4,#e6fff0); }
    .theme-blue { background: linear-gradient(180deg,#f0f7ff,#e6f0ff); }

    /* responsive container */
    .container-max { max-width: 1100px; margin-left:auto;margin-right:auto; }
  </style>
</head>
<body class="min-h-screen antialiased">

  <!-- NAV -->
  <header class="w-full shadow sticky top-0 bg-white z-40">
    <div class="container-max px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="text-xl font-bold">MyQuiz</div>
        <nav class="hidden md:flex gap-2">
          <button id="navHome" class="px-3 py-1 text-sm text-gray-700 hover:bg-gray-100 rounded" onclick="goHome()">หน้าแรก</button>
          <button id="navQuiz" class="px-3 py-1 text-sm text-gray-700 hover:bg-gray-100 rounded" onclick="goQuiz()">ข้อสอบ</button>
          <div class="relative">
            <button id="navResults" class="px-3 py-1 text-sm text-gray-700 hover:bg-gray-100 rounded">ผลลัพธ์ ▾</button>
            <div id="resultsMenu" class="hidden absolute right-0 mt-2 bg-white border rounded shadow p-2 w-44">
              <!-- result items inserted dynamically -->
            </div>
          </div>
        </nav>
      </div>

      <div class="flex items-center gap-3">
        <div id="loggedUser" class="text-sm text-gray-600"></div>
        <button id="btnLogout" class="text-sm text-red-600 hidden" onclick="logout()">ออกจากระบบ</button>
        <button id="mobileMenuBtn" class="md:hidden px-2 py-1 bg-gray-100 rounded" onclick="toggleMobile()">เมนู</button>
      </div>
    </div>

    <!-- mobile -->
    <div id="mobileNav" class="md:hidden hidden bg-white border-t">
      <div class="flex flex-col p-3 gap-2">
        <button onclick="goHome()">หน้าแรก</button>
        <button onclick="goQuiz()">ข้อสอบ</button>
        <button onclick="showResultsMenuMobile()">ผลลัพธ์</button>
      </div>
    </div>
  </header>

  <main class="container-max p-4">

    <!-- HOME -->
    <section id="homeSection" class="mt-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
        <div class="bg-white p-6 rounded-lg shadow">
          <h1 class="text-2xl font-bold mb-2">ระบบข้อสอบออนไลน์ (เก็บที่ localStorage)</h1>
          <p class="text-sm text-gray-600 mb-4">เข้าสู่ระบบผ่าน LINE เพื่อเริ่มทำข้อสอบทีละข้อ สามารถกลับมาทำต่อได้ด้วยบัญชี LINE เดิม</p>

          <label class="block text-sm mb-1">ธีม</label>
          <select id="themeSelect" class="w-full border p-2 rounded mb-3">
            <option value="pink">ชมพู</option>
            <option value="green">เขียว</option>
            <option value="blue">น้ำเงิน</option>
          </select>

          <div class="flex gap-2">
            <button id="btnStart" class="flex-1 bg-green-600 text-white p-2 rounded" onclick="handleLineLogin()">เข้าสู่ระบบ LINE</button>
            <button class="bg-red-100 text-red-600 p-2 rounded" onclick="clearAll()">ล้างข้อมูลทั้งหมด</button>
          </div>

          <p id="homeInfo" class="mt-3 text-sm text-gray-500"></p>
        </div>

        <div id="panelSummary" class="bg-white p-6 rounded-lg shadow">
          <h3 class="font-semibold mb-2">สถานะชุดข้อสอบ</h3>
          <div id="setsStatus" class="space-y-2 text-sm text-gray-700">
            <!-- filled dynamically -->
          </div>
        </div>
      </div>
    </section>

    <!-- SELECT / QUIZ -->
    <section id="quizSection" class="hidden mt-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="text-sm text-gray-600">ผู้ใช้: <span id="displayEmail" class="font-medium"></span></div>
            <div id="displaySetTitle" class="text-lg font-semibold mt-1"></div>
          </div>

        <div class="flex items-center gap-3">
            <label class="text-sm">ชุดข้อสอบ</label>
            <select id="setSelect" class="border p-2 rounded" onchange="handleSetChange()"></select>

            <label class="text-sm">เวลา/ข้อ (วินาที)</label>
            <input id="timePerQuestion" type="number" min="5" value="60" class="w-20 border p-1 rounded text-sm">
            <button class="bg-green-600 text-white px-3 py-2 rounded" onclick="startQuiz()">เริ่มชุดนี้</button>
          </div>
        </div>

        <div class="mt-6">
          <div class="w-full bg-gray-200 h-3 rounded overflow-hidden">
            <div id="progressFill" class="h-3 bg-blue-600" style="width:0%"></div>
          </div>
          <div class="flex justify-between text-sm text-gray-600 mt-2">
            <div id="qIndicator">ข้อที่ 0 / 0</div>
            <div id="timerDisplay">เวลาที่เหลือ: <span id="timeLeft">0</span>s</div>
          </div>

          <div id="questionCard" class="mt-4 p-4 border rounded bg-white min-h-[140px]">
            <div id="questionText" class="font-semibold text-lg"></div>
            <div id="choicesBox" class="mt-3 grid gap-2"></div>
          </div>

          <div class="mt-4 flex justify-between">
            <button class="px-4 py-2 bg-gray-300 rounded" onclick="prevQuestion()">ย้อนกลับ</button>
            <div class="flex gap-2">
              <button class="px-4 py-2 bg-yellow-500 text-white rounded" onclick="saveAndQuit()">บันทึกแล้วออก</button>
              <button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="nextQuestion()">ถัดไป</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULT -->
    <section id="resultSection" class="hidden mt-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-gray-600">ผลลัพธ์ของ: <span id="resEmail" class="font-medium"></span></div>
            <div id="resSetTitle" class="text-xl font-bold mt-1"></div>
            <div id="resScore" class="text-lg text-green-600 mt-1"></div>
          </div>
          <div class="w-48 h-48">
            <canvas id="scoreChart"></canvas>
          </div>
        </div>

        <div class="mt-6">
          <h4 class="font-semibold mb-2">เฉลย</h4>
          <div id="answerList" class="space-y-2 max-h-[400px] overflow-auto"></div>
        </div>

        <div class="mt-4 flex gap-2">
          <button class="px-4 py-2 bg-gray-300 rounded" onclick="goHome()">กลับหน้าหลัก</button>
          <button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="goBackToSetSelect()">กลับไปชุดข้อสอบ</button>
        </div>
      </div>
    </section>

  </main>

<script>
/* -------------------------
  Global app state
--------------------------*/
let setsData = []; // loaded from JSON
let userLineId = null; // changed from email to LINE user ID
let theme = null;
let currentSetIndex = 0;
let currentQuiz = [];
let userAnswers = {}; // mapping questionIndex -> selectedChoice
let currentIndex = 0;
let timer = null;
let timePerQuestion = 60;
const LIFF_ID = '2006372130-PYKdNb1r'; // LINE LIFF ID

/* ---------- helpers for storage keys ---------- */
function storageKeyAnswers(setIndex, lineId) {
  return `quiz_answers_${lineId}_set${setIndex}`;
}
function storageKeyMeta(lineId) {
  return `quiz_meta_${lineId}`; // store unlocked, theme etc.
}

/* ---------- LIFF initialization ---------- */
async function initializeLIFF() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      const profile = await liff.getProfile();
      userLineId = profile.userId;
      localStorage.setItem('quizUserLineId', userLineId);
      // update UI
      document.getElementById('loggedUser').innerText = `${profile.displayName || 'ผู้ใช้'} (LINE)`;
      document.getElementById('btnLogout').classList.remove('hidden');
      
      // auto load quiz or show set selection
      loadAfterLogin();
    }
  } catch (e) {
    console.error('LIFF init error:', e);
    alert('ไม่สามารถเชื่อมต่อ LINE ได้: ' + e.message);
  }
}

async function handleLineLogin() {
  if (!liff.isLoggedIn()) {
    liff.login();
  } else {
    try {
      const profile = await liff.getProfile();
      userLineId = profile.userId;
      localStorage.setItem('quizUserLineId', userLineId);
      document.getElementById('loggedUser').innerText = `${profile.displayName || 'ผู้ใช้'} (LINE)`;
      document.getElementById('btnLogout').classList.remove('hidden');
      
      loadAfterLogin();
    } catch (e) {
      console.error('Failed to get profile:', e);
      alert('ไม่สามารถดึงข้อมูลบัญชี LINE ได้');
    }
  }
}

function loadAfterLogin() {
  const meta = loadMeta();
  const unlocked = meta ? (meta.unlocked || 0) : 0;
  
  // if there is incomplete work on any unlocked set, load that automatically
  for (let i=0;i<=unlocked;i++){
    const answers = loadAnswers(i);
    const answeredCount = Object.keys(answers).length;
    const total = setsData[i].questions.length;
    if (answeredCount>0 && answeredCount<total) {
      // resume this set
      currentSetIndex = i;
      currentQuiz = setsData[i].questions;
      userAnswers = answers;
      currentIndex = answeredCount; // continue next unanswered
      openQuizUI();
      loadQuestion();
      return;
    }
  }

  // else go to set selection
  document.getElementById('homeInfo').innerText = `เลือกชุดข้อสอบหรือตั้งค่าเวลา`;
  goSetPage();
}

/* ---------- fetch questions JSON ---------- */
async function loadQuestions() {
  try {
    const res = await fetch('questions.json');
    if (!res.ok) throw new Error('ไม่สามารถโหลด questions.json ได้');
    const data = await res.json();
    setsData = data.sets;
    renderSetSelect();
    renderSetsStatus();
  } catch (e) {
    alert('โหลดคำถามล้มเหลว: ' + e.message + '\n(ต้องวาง questions.json ในโฟลเดอร์เดียวกัน และเปิดผ่านเว็บเซิร์ฟเวอร์)');
    console.error(e);
  }
}

/* ---------- UI render helpers ---------- */
function renderSetSelect() {
  const sel = document.getElementById('setSelect');
  sel.innerHTML = '';
  setsData.forEach((s, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `ชุดที่ ${i+1} - ${s.title || ''}`;
    sel.appendChild(opt);
  });
  updateUnlockedOptions();
}

function updateUnlockedOptions() {
  const sel = document.getElementById('setSelect');
  const meta = loadMeta();
  const unlocked = meta ? (meta.unlocked || 0) : 0;
  Array.from(sel.options).forEach((opt, idx) => {
    opt.disabled = idx > unlocked;
    opt.innerText = `ชุดที่ ${idx+1} - ${setsData[idx].title || ''}` + (idx > unlocked ? ' (ล็อก)' : '');
  });
  // rebuild results menu
  buildResultsMenu();
}

function updateUnlockedFromMeta() {
  updateUnlockedOptions();
}

function renderSetsStatus() {
  const div = document.getElementById('setsStatus');
  div.innerHTML = '';
  setsData.forEach((s, i) => {
    const saved = loadAnswers(i);
    const answered = Object.keys(saved).length;
    const total = s.questions.length;
    const el = document.createElement('div');
    el.className = 'flex items-center justify-between';
    el.innerHTML = `<div><strong>ชุด ${i+1}</strong> ${s.title ? '- ' + s.title : ''}</div>
      <div class="text-sm text-gray-600">${answered}/${total} ข้อ</div>`;
    div.appendChild(el);
  });
}

/* ---------- load/save meta ---------- */
function loadMeta() {
  const lineId = localStorage.getItem('quizUserLineId');
  if (!lineId) return null;
  const raw = localStorage.getItem(storageKeyMeta(lineId));
  return raw ? JSON.parse(raw) : { unlocked:0, theme:'pink' };
}
function saveMeta(meta){
  const lineId = localStorage.getItem('quizUserLineId');
  if (!lineId) return;
  localStorage.setItem(storageKeyMeta(lineId), JSON.stringify(meta));
}

/* ---------- load/save answers ---------- */
function loadAnswers(setIndex) {
  const lineId = localStorage.getItem('quizUserLineId');
  if (!lineId) return {};
  const raw = localStorage.getItem(storageKeyAnswers(setIndex, lineId));
  return raw ? JSON.parse(raw) : {};
}
function saveAnswers(setIndex, answers) {
  const lineId = localStorage.getItem('quizUserLineId');
  if (!lineId) return;
  localStorage.setItem(storageKeyAnswers(setIndex, lineId), JSON.stringify(answers));
  renderSetsStatus();
}

/* ---------- handle start / login ---------- */
function handleStart(){
  const th = document.getElementById('themeSelect').value;
  if (!userLineId) {
    alert('กรุณาเข้าสู่ระบบ LINE ก่อน');
    return;
  }
  
  // load meta if any
  let meta = loadMeta();
  if (!meta) {
    meta = { unlocked:0, theme: th };
    saveMeta(meta);
  } else {
    // keep stored theme unless user changed
    meta.theme = th;
    saveMeta(meta);
  }
  applyTheme(meta.theme);

  // if there is incomplete work on any unlocked set, load that automatically
  const unlocked = meta.unlocked || 0;
  for (let i=0;i<=unlocked;i++){
    const answers = loadAnswers(i);
    const answeredCount = Object.keys(answers).length;
    const total = setsData[i].questions.length;
    if (answeredCount>0 && answeredCount<total) {
      // resume this set
      currentSetIndex = i;
      currentQuiz = setsData[i].questions;
      userAnswers = answers;
      currentIndex = answeredCount; // continue next unanswered
      openQuizUI();
      loadQuestion();
      return;
    }
  }

  // else go to set selection
  document.getElementById('homeInfo').innerText = `เลือกชุดข้อสอบหรือตั้งค่าเวลา`;
  goSetPage();
}

/* ---------- theme ---------- */
function applyTheme(th){
  document.body.classList.remove('theme-pink','theme-green','theme-blue');
  if (th === 'pink') document.body.classList.add('theme-pink');
  if (th === 'green') document.body.classList.add('theme-green');
  if (th === 'blue') document.body.classList.add('theme-blue');
}

/* ---------- navigation helpers ---------- */
function goHome(){ showSection('homeSection'); }
function goSetPage(){ 
  updateUnlockedOptions();
  document.getElementById('setSelect').value = 0; // reset to first set
  goQuiz(); 
} // alias for quiz page with set selection
function goQuiz(){ showSection('quizSection'); }
function goBackToSetSelect(){
  // Go back to quiz section and set dropdown to current set
  updateUnlockedOptions();
  document.getElementById('setSelect').value = currentSetIndex;
  document.getElementById('displaySetTitle').innerText = `ชุดที่ ${currentSetIndex+1} - ${setsData[currentSetIndex].title}`;
  goQuiz();
}
function goResults(){ showSection('resultSection'); }

/* mobile */
function toggleMobile(){ document.getElementById('mobileNav').classList.toggle('hidden'); }

/* ---------- start quiz ---------- */
function handleSetChange(){
  const sel = document.getElementById('setSelect');
  const idx = Number(sel.value);
  // just update the display, don't start yet
  if (setsData[idx]) {
    document.getElementById('displaySetTitle').innerText = `ชุดที่ ${idx+1} - ${setsData[idx].title}`;
  }
  startQuiz();
}

function startQuiz(){
  const sel = document.getElementById('setSelect');
  const idx = Number(sel.value);
  currentSetIndex = idx;
  currentQuiz = setsData[idx].questions;
  userAnswers = loadAnswers(idx) || {};
  currentIndex = 0;
  timePerQuestion = Number(document.getElementById('timePerQuestion').value) || 60;
  openQuizUI();
  loadQuestion();
}

/* open quiz UI (fill titles) */
function openQuizUI(){
  document.getElementById('displayEmail').innerText = userLineId || '';
  document.getElementById('displaySetTitle').innerText = `ชุดที่ ${currentSetIndex+1} - ${setsData[currentSetIndex].title}`;
  showSection('quizSection');
  document.getElementById('navQuiz').classList.add('active');
  updateUnlockedOptions();
  buildResultsMenu();
}

/* ---------- question rendering + timer ---------- */
function loadQuestion(){
  // clear previous timer
  stopTimer();

  if (!currentQuiz || currentQuiz.length===0) return;

  const q = currentQuiz[currentIndex];
  document.getElementById('questionText').innerText = `ข้อ ${currentIndex+1}: ${q.q}`;
  const choicesBox = document.getElementById('choicesBox');
  choicesBox.innerHTML = '';
  q.choices.forEach((c, idx) => {
    const checked = (userAnswers[currentIndex] === c) ? 'checked' : '';
    const lbl = document.createElement('label');
    lbl.className = 'flex items-center gap-3 p-2 border rounded hover:bg-gray-50';
    lbl.innerHTML = `<input type="radio" name="choice" value="${c}" ${checked}> <span>${c}</span>`;
    choicesBox.appendChild(lbl);
  });

  // update counters
  document.getElementById('qIndicator').innerText = `ข้อที่ ${currentIndex+1} / ${currentQuiz.length}`;
  // start timer
  timePerQuestion = Number(document.getElementById('timePerQuestion').value) || 60;
  startTimer(timePerQuestion);
  updateProgressFill();
}

/* save selected answer */
function saveCurrentAnswer(){
  const sel = document.querySelector("input[name='choice']:checked");
  if (sel){
    userAnswers[currentIndex] = Number(sel.value);
    saveAnswers(currentSetIndex, userAnswers);
  }
}

/* next / prev */
function nextQuestion(){
  // try save
  saveCurrentAnswer();
  // enforce answer?
  if (userAnswers[currentIndex] === undefined){
    if (confirm('คุณยังไม่ได้ตอบข้อปัจจุบัน ต้องการข้ามหรือไม่? (ถ้าตั้งห้ามข้าม จะต้องตอบก่อน)')) {
      // allow skip if user confirms
    } else {
      return; // stop
    }
  }
  if (currentIndex < currentQuiz.length-1){
    currentIndex++;
    loadQuestion();
  } else {
    // finish
    saveCurrentAnswer();
    showResultFor(currentSetIndex);
  }
}

function prevQuestion(){
  saveCurrentAnswer();
  if (currentIndex>0){
    currentIndex--;
    loadQuestion();
  }
}

/* save & quit (user chooses to stop and return later) */
function saveAndQuit(){
  saveCurrentAnswer();
  alert('บันทึกเรียบร้อย คุณสามารถกลับมาทำต่อได้โดยใช้เมลเดิม');
  goHome();
}

/* ---------- timer ---------- */
let remaining = 0;
function startTimer(seconds){
  remaining = seconds;
  document.getElementById('timeLeft').innerText = remaining;
  timer = setInterval(()=>{
    remaining--;
    document.getElementById('timeLeft').innerText = remaining;
    if (remaining<=0){
      clearInterval(timer);
      // on timeout: treat as unanswered (or leave undefined) and go next
      // here we leave unanswered and move on
      if (currentIndex < currentQuiz.length-1) {
        currentIndex++;
        loadQuestion();
      } else {
        showResultFor(currentSetIndex);
      }
    }
  },1000);
}
function stopTimer(){ if (timer) { clearInterval(timer); timer = null; } }

/* ---------- progress bar ---------- */
function updateProgressFill(){
  const ratio = ((currentIndex+1)/currentQuiz.length)*100;
  document.getElementById('progressFill').style.width = ratio + '%';
}

/* ---------- show results UI ---------- */
function showResultFor(setIndex){
  stopTimer();
  const set = setsData[setIndex];
  const answers = loadAnswers(setIndex);
  // ensure store current answers too
  saveAnswers(setIndex, userAnswers);

  // compute stats
  const total = set.questions.length;
  let correct = 0;
  let answered = Object.keys(answers).length;
  // compute correct using saved userAnswers (merged)
  const merged = {...answers, ...userAnswers};
  for (let i=0;i<total;i++){
    if (merged[i] !== undefined && merged[i] === set.questions[i].answer) correct++;
  }

  // write summary UI
  document.getElementById('resEmail').innerText = userLineId || '';
  document.getElementById('resSetTitle').innerText = `ชุดที่ ${setIndex+1} - ${set.title}`;
  document.getElementById('resScore').innerText = `ถูก ${correct} / ${total} (ตอบแล้ว ${answered}/${total})`;

  // list answers & show correct/incorrect
  const list = document.getElementById('answerList');
  list.innerHTML = '';
  for (let i=0;i<total;i++){
    const q = set.questions[i];
    const ans = merged[i];
    const ok = (ans !== undefined && ans === q.answer);
    const el = document.createElement('div');
    el.className = 'p-2 border-b';
    el.innerHTML = `<div class="font-medium">ข้อ ${i+1}: ${q.q}</div>
      <div>คำตอบของคุณ: <span class="${ok ? 'text-green-600' : 'text-red-600'}">${ans ?? '- (ไม่ได้ตอบ)'}</span></div>
      <div class="text-blue-700">เฉลย: ${q.answer}</div>`;
    list.appendChild(el);
  }

  // chart
  renderChart(correct, total);

  // unlock logic: if correct >= threshold
  const threshold = Math.ceil(total * 0.5); // >=50% (you can change)
  if (correct >= threshold && setIndex < setsData.length-1){
    // set next unlocked in meta
    const meta = loadMeta();
    if (meta){
      const nowUnlocked = Math.max(meta.unlocked || 0, setIndex+1);
      meta.unlocked = nowUnlocked;
      saveMeta(meta);
      updateUnlockedOptions();
      // auto-select next set for convenience
      const sel = document.getElementById('setSelect');
      if (sel){
        sel.value = Math.min(nowUnlocked, setsData.length-1);
      }
      // notify
      alert(`ผ่านเกณฑ์ (${correct}/${total}) — ปลดล็อกชุดถัดไปแล้ว`);
    }
  }

  showSection('resultSection');
  // rebuild results menu
  updateUnlockedOptions(); // update dropdown status
  buildResultsMenu();
}

/* ---------- chart ---------- */
let scoreChart = null;
function renderChart(correct,total){
  const ctx = document.getElementById('scoreChart').getContext('2d');
  if (scoreChart) scoreChart.destroy();
  scoreChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['ถูก','ผิด'],
      datasets: [{
        data: [correct, total - correct],
        backgroundColor:['#16a34a','#ef4444']
      }]
    },
    options: { responsive:true, maintainAspectRatio: false }
  });
}

/* ---------- results menu (nav) ---------- */
function buildResultsMenu(){
  const menu = document.getElementById('resultsMenu');
  menu.innerHTML = '';
  const lineId = localStorage.getItem('quizUserLineId');
  const meta = loadMeta();
  const unlocked = meta ? (meta.unlocked || 0) : 0;
  setsData.forEach((s, i) => {
    const item = document.createElement('button');
    item.className = 'w-full text-left p-1 hover:bg-gray-50';
    item.disabled = (i > unlocked);
    item.innerText = `ชุด ${i+1} ${s.title ? '- ' + s.title : ''}` + (i>unlocked ? ' (ล็อก)' : '');
    item.onclick = ()=> {
      // only show result if there is any saved data
      const saved = loadAnswers(i);
      if (!saved || Object.keys(saved).length===0) {
        alert('ยังไม่มีผลลัพธ์ชุดนี้');
        return;
      }
      // load merged answers
      userAnswers = saved;
      showResultFor(i);
    };
    menu.appendChild(item);
  });
}

/* mobile results */
function showResultsMenuMobile(){
  // same as buildResultsMenu but mobile alert list
  let text = '';
  const meta = loadMeta(); const unlocked = meta ? meta.unlocked||0:0;
  setsData.forEach((s,i)=>{ text += `${i+1}. ${s.title} ${i>unlocked? '(ล็อก)':''}\n`; });
  alert('ชุดข้อสอบ:\n' + text + '\nใช้เมนูบน Desktop เพื่อดูผลของชุดที่เคยทำแล้ว');
}

/* ---------- utility: logout / clear ---------- */
function logout(){
  stopTimer();
  userLineId = null;
  localStorage.removeItem('quizUserLineId');
  document.getElementById('loggedUser').innerText = '';
  document.getElementById('btnLogout').classList.add('hidden');
  if (liff.isLoggedIn()) {
    liff.logout();
  }
  goHome();
}

function clearAll(){
  if (!confirm('ต้องการล้างข้อมูลทั้งหมด?')) return;
  localStorage.clear();
  location.reload();
}

/* ---------- page utils ---------- */
function showSection(id){
  document.getElementById('homeSection').classList.add('hidden');
  document.getElementById('quizSection').classList.add('hidden');
  document.getElementById('resultSection').classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
  // update status displays
  document.getElementById('homeInfo').innerText = userLineId ? `เข้าสู่ระบบแล้ว` : '';
  document.getElementById('loggedUser').innerText = userLineId ? `ผู้ใช้ LINE: ${userLineId.substring(0, 10)}...` : '';
}

/* ---------- initial setup ---------- */
window.addEventListener('load', async ()=>{
  await loadQuestions();
  // Initialize LIFF
  await initializeLIFF();
  buildResultsMenu();
});

</script>
</body>
</html>
